<!-- livebook:{"app_settings":{"slug":"antipop"},"persist_outputs":true} -->

# Image Prediction using a Standalone Wasm Binary on Local Machine

```elixir
Mix.install([
  {:nx, "~> 0.5.1"},
  {:nx_image, "~> 0.1.0"},
  {:kino, "~> 0.8.1"},
  {:req, "~> 0.3.5"},
  {:benchee, "~> 1.1.0"},
  {:wasmtube, github: "kentaro/wasmtube", branch: :main}
])
```

<!-- livebook:{"output":true} -->

```
* Getting wasmtube (https://github.com/kentaro/wasmtube.git - origin/main)
remote: Enumerating objects: 1020, done.        
remote: Counting objects: 100% (243/243), done.        
remote: Compressing objects: 100% (147/147), done.        
remote: Total 1020 (delta 108), reused 193 (delta 67), pack-reused 777        
Resolving Hex dependencies...
Resolution completed in 0.361s
New:
  benchee 1.1.0
  castore 0.1.22
  complex 0.5.0
  deep_merge 1.0.0
  file_system 0.2.10
  finch 0.15.0
  hpax 0.1.2
  jason 1.4.0
  kino 0.8.1
  mime 2.0.3
  mint 1.5.1
  nimble_options 1.0.1
  nimble_pool 0.2.6
  nx 0.5.2
  nx_image 0.1.1
  req 0.3.6
  rustler_precompiled 0.5.5
  sleeplocks 1.1.2
  statistex 1.0.0
  table 0.1.2
  telemetry 1.2.1
  wasmex 0.8.2
* Getting nx (Hex package)
* Getting nx_image (Hex package)
* Getting kino (Hex package)
* Getting req (Hex package)
* Getting benchee (Hex package)
* Getting wasmex (Hex package)
* Getting jason (Hex package)
* Getting file_system (Hex package)
* Getting sleeplocks (Hex package)
* Getting rustler_precompiled (Hex package)
* Getting castore (Hex package)
* Getting deep_merge (Hex package)
* Getting statistex (Hex package)
* Getting finch (Hex package)
* Getting mime (Hex package)
* Getting mint (Hex package)
* Getting nimble_options (Hex package)
* Getting nimble_pool (Hex package)
* Getting telemetry (Hex package)
* Getting hpax (Hex package)
* Getting table (Hex package)
* Getting complex (Hex package)

19:11:51.744 [info] Compiling file system watcher for Mac...

19:11:52.556 [info] Done.
==> file_system
Compiling 7 files (.ex)
Generated file_system app
==> deep_merge
Compiling 2 files (.ex)
Generated deep_merge app
==> table
Compiling 5 files (.ex)
Generated table app
==> mime
Compiling 1 file (.ex)
Generated mime app
==> nimble_options
Compiling 3 files (.ex)
Generated nimble_options app
===> Analyzing applications...
===> Compiling telemetry
==> jason
Compiling 10 files (.ex)
Generated jason app
==> statistex
Compiling 3 files (.ex)
Generated statistex app
==> hpax
Compiling 4 files (.ex)
Generated hpax app
===> Analyzing applications...
===> Compiling sleeplocks
==> complex
Compiling 2 files (.ex)
Generated complex app
==> nx
Compiling 31 files (.ex)
Generated nx app
==> nx_image
Compiling 1 file (.ex)
Generated nx_image app
==> kino
Compiling 37 files (.ex)
Generated kino app
==> nimble_pool
Compiling 2 files (.ex)
Generated nimble_pool app
==> benchee
Compiling 44 files (.ex)
Generated benchee app
==> castore
Compiling 1 file (.ex)
Generated castore app
==> rustler_precompiled
Compiling 4 files (.ex)
Generated rustler_precompiled app
==> wasmex
Compiling 14 files (.ex)

19:12:08.062 [debug] Copying NIF from cache and extracting to /Users/antipop/Library/Caches/mix/installs/elixir-1.14.3-erts-13.1.4/910aa37ed68d5a17f1379f97c568e2b5/_build/rpi4_dev/lib/wasmex/priv/native/libwasmex-v0.8.2-nif-2.16-aarch64-apple-darwin.so
Generated wasmex app
==> wasmtube
Compiling 4 files (.ex)
Generated wasmtube app
==> mint
Compiling 1 file (.erl)
Compiling 19 files (.ex)
Generated mint app
==> finch
Compiling 13 files (.ex)
Generated finch app
==> req
Compiling 5 files (.ex)
Generated req app
```

<!-- livebook:{"output":true} -->

```
:ok
```

## Experimental environment

* Machine: iMac
  * CPU: M1
  * Architecture: arm64
  * Memory: 16GB
* OS: macOS 13.2
* Runtime: Elixir v1.14.3

## Uploading an image to be predicted

```elixir
input = Kino.Input.image("Upload an image to be predicted")
```

This is a sample image that is used in this livebook.

![](https://upload.wikimedia.org/wikipedia/commons/4/40/Just_one_lion.jpg?20061206183417)
[File:Just one lion.jpg - Wikimedia Commons](https://commons.wikimedia.org/wiki/File:Just_one_lion.jpg)

## Preprocessing the image

```elixir
image = input |> Kino.Input.read()

nx_image =
  image.data
  |> Nx.from_binary(:u8)
  |> Nx.reshape({image.height, image.width, 3})
  |> NxImage.resize({224, 224}, method: :nearest)

kino_image =
  nx_image
  |> Kino.Image.new()
```

## Preparing label data

```elixir
label_data =
  Req.get!("https://raw.githubusercontent.com/kazum/tvm-wasm/master/synset.csv")
  |> Map.get(:body)
  |> String.trim()
  |> String.split("\r\n")
  |> Enum.reduce(%{}, fn line, acc ->
    [k, v] = line |> String.split(",", parts: 2)
    acc |> Map.put(String.to_integer(k), v)
  end)
```

<!-- livebook:{"output":true} -->

```
%{
  912 => "\"worm fence, snake fence, snake-rail fence, Virginia fence\"",
  326 => "\"lycaenid, lycaenid butterfly\"",
  33 => "\"loggerhead, loggerhead turtle, Caretta caretta\"",
  289 => "\"snow leopard, ounce, Panthera uncia\"",
  518 => "crash helmet",
  990 => "\"buckeye, horse chestnut, conker\"",
  456 => "bow",
  401 => "\"accordion, piano accordion, squeeze box\"",
  168 => "redbone",
  309 => "bee",
  117 => "\"chambered nautilus, pearly nautilus, nautilus\"",
  377 => "marmoset",
  579 => "\"grand piano, grand\"",
  277 => "\"red fox, Vulpes vulpes\"",
  399 => "abaya",
  413 => "\"assault rifle, assault gun\"",
  477 => "\"carpenter's kit, tool kit\"",
  246 => "Great Dane",
  704 => "parking meter",
  175 => "\"otterhound, otter hound\"",
  740 => "power drill",
  621 => "\"lawn mower, mower\"",
  869 => "trench coat",
  219 => "\"cocker spaniel, English cocker spaniel, cocker\"",
  923 => "plate",
  492 => "chest",
  360 => "otter",
  669 => "mosquito net",
  12 => "\"house finch, linnet, Carpodacus mexicanus\"",
  192 => "\"cairn, cairn terrier\"",
  974 => "geyser",
  311 => "\"grasshopper, hopper\"",
  864 => "\"tow truck, tow car, wrecker\"",
  327 => "\"starfish, sea star\"",
  916 => "\"web site, website, internet site, site\"",
  188 => "wire-haired fox terrier",
  270 => "\"white wolf, Arctic wolf, Canis lupus tundrarum\"",
  157 => "papillon",
  564 => "four-poster",
  559 => "folding chair",
  349 => "\"bighorn, bighorn sheep, cimarron, Rocky Mountain bighorn, Rocky Mountain sheep, Ovis canadensis\"",
  636 => "\"mailbag, postbag\"",
  132 => "\"American egret, great white heron, Egretta albus\"",
  770 => "running shoe",
  513 => "\"cornet, horn, trumpet, trump\"",
  405 => "\"airship, dirigible\"",
  73 => "\"barn spider, Araneus cavaticus\"",
  328 => "sea urchin",
  822 => "steel drum",
  427 => "\"barrel, cask\"",
  ...
}
```

## Prediction with Wasm binary (ResNet50)

```elixir
resnet50_wasm =
  Wasmtube.from_file("/Users/kentaro/src/github.com/kentaro/elixir-ml-wasm/wasm/resnet50.wasm")

resnet50_result =
  resnet50_wasm
  |> Wasmtube.call_function("predict", image: kino_image.content, width: 224, height: 224)
```

<!-- livebook:{"output":true} -->

```
%{
  "data" => [-1.2380532, -3.5076628, -1.745974, -2.5777662, -2.575174, 0.00320144, -1.8548435,
   1.9798119, 0.8790855, 2.6920712, -1.6338683, -2.262256, -1.7829849, -3.352644, -2.6420937,
   -1.8500642, -1.9090271, -0.8531388, -0.61099184, -3.1587193, -2.0874774, 2.5533094, 1.2311407,
   1.499493, 2.5900023, -1.0595945, -1.6094693, -1.8300521, -1.3385713, -2.9864905, -0.78965205,
   -2.2536402, -1.1391659, -2.6450782, -3.3188202, -3.0392742, -2.900531, -2.6652336, -0.8872474,
   -0.7320179, -2.1677976, -2.5951917, -1.1870259, 0.06935866, -1.2533929, -0.8644694, -3.7154303,
   0.23462734, -0.81006914, ...],
  "dtype" => "FP32",
  "shape" => [1, 1000],
  "strides" => nil
}
```

## Prediction with Wasm binary (MobileNet2)

```elixir
mobilenetv2_wasm =
  Wasmtube.from_file("/Users/kentaro/src/github.com/kentaro/elixir-ml-wasm/wasm/mobilenetv2.wasm")

mobilenetv2_result =
  mobilenetv2_wasm
  |> Wasmtube.call_function("predict", image: kino_image.content, width: 224, height: 224)
```

<!-- livebook:{"output":true} -->

```
%{
  "data" => [-2.9272294, -6.9886975, -3.4781256, -6.5197406, -5.079295, -2.939178, -3.6940205,
   1.2186813, 6.1876426, 2.8756125, -1.5650505, 0.40949318, 0.7039441, -2.9523182, -1.2515951,
   -3.3379555, -3.3519793, -1.4937574, -0.956601, -2.303063, -4.6055946, 0.48778173, 0.21371013,
   1.5368593, -0.48593968, -5.9181027, -6.4475255, -5.8687377, -6.2086544, -9.242665, -2.5257566,
   -4.0419445, -4.70027, -5.198278, -6.680466, -4.3889465, -3.2650526, -1.9704617, -2.3872275,
   -2.0531871, -2.6466992, -4.6954436, -4.2617893, -1.6960688, -4.7365513, -5.465204, -4.686872,
   -2.6651733, -4.0335364, ...],
  "dtype" => "FP32",
  "shape" => [1, 1000],
  "strides" => nil
}
```

## Find an index whose value is highest

```elixir
find_max = fn result ->
  {max_index, max_value} =
    result
    |> Map.get("data")
    |> Enum.with_index()
    |> Enum.reduce({0, 0}, fn {v, i}, acc ->
      {_, max_value} = acc

      if v > max_value do
        {i, v}
      else
        acc
      end
    end)

  {max_index, max_value}
end

{resnet50_max_index, resnet50_max_value} = resnet50_result |> find_max.() |> IO.inspect()
{mobilenetv2_max_index, mobilenetv2_max_value} = mobilenetv2_result |> find_max.() |> IO.inspect()
```

<!-- livebook:{"output":true} -->

```
{291, 15.836072}
{291, 16.522993}
```

<!-- livebook:{"output":true} -->

```
{291, 16.522993}
```

## Prediction result

```elixir
label_data[resnet50_max_index] |> IO.inspect()
label_data[mobilenetv2_max_index] |> IO.inspect()
```

<!-- livebook:{"output":true} -->

```
"\"lion, king of beasts, Panthera leo\""
"\"lion, king of beasts, Panthera leo\""
```

<!-- livebook:{"output":true} -->

```
"\"lion, king of beasts, Panthera leo\""
```

## Benchmark

```elixir
resnet50_wasm_func = fn ->
  resnet50_wasm
  |> Wasmtube.call_function("predict", image: kino_image.content, width: 224, height: 224)
end

mobilenetv2_wasm_func = fn ->
  mobilenetv2_wasm
  |> Wasmtube.call_function("predict", image: kino_image.content, width: 224, height: 224)
end

Benchee.run(%{
  "Wasm (ResNet50)" => resnet50_wasm_func,
  "Wasm (MobileNetV2)" => mobilenetv2_wasm_func
})
```

<!-- livebook:{"output":true} -->

```
Operating System: macOS
CPU Information: Apple M1 Max
Number of Available Cores: 10
Available memory: 64 GB
Elixir 1.14.3
Erlang 25.2.1

Benchmark suite executing with the following configuration:
warmup: 2 s
time: 5 s
memory time: 0 ns
reduction time: 0 ns
parallel: 1
inputs: none specified
Estimated total run time: 14 s

Benchmarking Wasm (MobileNetV2) ...
Benchmarking Wasm (ResNet50) ...

Name                         ips        average  deviation         median         99th %
Wasm (MobileNetV2)         19.02       52.57 ms     ±2.18%       52.22 ms       58.17 ms
Wasm (ResNet50)             3.71      269.88 ms     ±0.78%      269.12 ms      275.44 ms

Comparison: 
Wasm (MobileNetV2)         19.02
Wasm (ResNet50)             3.71 - 5.13x slower +217.32 ms
```

<!-- livebook:{"output":true} -->

```
%Benchee.Suite{
  system: %{
    available_memory: "64 GB",
    cpu_speed: "Apple M1 Max",
    elixir: "1.14.3",
    erlang: "25.2.1",
    num_cores: 10,
    os: :macOS
  },
  configuration: %Benchee.Configuration{
    parallel: 1,
    time: 5000000000.0,
    warmup: 2000000000.0,
    memory_time: 0.0,
    reduction_time: 0.0,
    pre_check: false,
    formatters: [Benchee.Formatters.Console],
    percentiles: '2c',
    print: %{benchmarking: true, configuration: true, fast_warning: true},
    inputs: nil,
    save: false,
    load: false,
    unit_scaling: :best,
    assigns: %{},
    before_each: nil,
    after_each: nil,
    before_scenario: nil,
    after_scenario: nil,
    measure_function_call_overhead: false,
    title: nil,
    profile_after: false
  },
  scenarios: [
    %Benchee.Scenario{
      name: "Wasm (MobileNetV2)",
      job_name: "Wasm (MobileNetV2)",
      function: #Function<43.3316493/0 in :erl_eval.expr/6>,
      input_name: :__no_input,
      input: :__no_input,
      before_each: nil,
      after_each: nil,
      before_scenario: nil,
      after_scenario: nil,
      tag: nil,
      run_time_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: 52566798.302083336,
          ips: 19.02341463243288,
          std_dev: 1146471.3874636302,
          std_dev_ratio: 0.021809800567941247,
          std_dev_ips: 0.41489687925461644,
          median: 52217530.0,
          percentiles: %{50 => 52217530.0, 99 => 58174678.0},
          mode: nil,
          minimum: 51513814,
          maximum: 58174678,
          relative_more: nil,
          relative_less: nil,
          absolute_difference: nil,
          sample_size: 96
        },
        samples: [51751192, 51891610, 51926111, 52367198, 52231405, 52166779, 51853776, 51852485,
         51940902, 52242948, 52283655, 55557276, 54384929, 52473700, 53036998, 52641492, 52446200,
         52567617, 52309865, 53475169, 52255572, 51944736, 52228739, 51929777, 53110789, 51924193,
         51901736, 51752400, 52024945, 52121238, 52010029, 51740233, 51890026, ...]
      },
      memory_usage_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: nil,
          ips: nil,
          std_dev: nil,
          std_dev_ratio: nil,
          std_dev_ips: nil,
          median: nil,
          percentiles: nil,
          mode: nil,
          minimum: nil,
          maximum: nil,
          relative_more: nil,
          relative_less: nil,
          absolute_difference: nil,
          sample_size: 0
        },
        samples: []
      },
      reductions_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: nil,
          ips: nil,
          std_dev: nil,
          std_dev_ratio: nil,
          std_dev_ips: nil,
          median: nil,
          percentiles: nil,
          mode: nil,
          minimum: nil,
          maximum: nil,
          relative_more: nil,
          relative_less: nil,
          absolute_difference: nil,
          sample_size: 0
        },
        samples: []
      }
    },
    %Benchee.Scenario{
      name: "Wasm (ResNet50)",
      job_name: "Wasm (ResNet50)",
      function: #Function<43.3316493/0 in :erl_eval.expr/6>,
      input_name: :__no_input,
      input: :__no_input,
      before_each: nil,
      after_each: nil,
      before_scenario: nil,
      after_scenario: nil,
      tag: nil,
      run_time_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: 269882358.94736844,
          ips: 3.7053181389859446,
          std_dev: 2112405.087449571,
          std_dev_ratio: 0.007827132887413086,
          std_dev_ips: 0.02900201746398514,
          median: 269123115.0,
          percentiles: %{50 => 269123115.0, 99 => 275436641.0},
          mode: nil,
          minimum: 267835808,
          maximum: 275436641,
          relative_more: 5.134084016234872,
          relative_less: 0.19477671125712495,
          absolute_difference: 217315560.6452851,
          sample_size: 19
        },
        samples: [275436641, 271344471, 268434023, 268387647, 268928237, 268264563, 270032498,
         269308241, 269123115, 269601827, 268804486, 270769131, 269821913, 275044179, 268851611,
         268983321, 270688589, 267835808, 268104519]
      },
      memory_usage_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: nil,
          ips: nil,
          std_dev: nil,
          std_dev_ratio: nil,
          std_dev_ips: nil,
          median: nil,
          percentiles: nil,
          mode: nil,
          minimum: nil,
          maximum: nil,
          relative_more: nil,
          relative_less: nil,
          absolute_difference: nil,
          sample_size: 0
        },
        samples: []
      },
      reductions_data: %Benchee.CollectionData{
        statistics: %Benchee.Statistics{
          average: nil,
          ips: nil,
          std_dev: nil,
          std_dev_ratio: nil,
          std_dev_ips: nil,
          median: nil,
          percentiles: nil,
          mode: nil,
          minimum: nil,
          maximum: nil,
          relative_more: nil,
          relative_less: nil,
          absolute_difference: nil,
          sample_size: 0
        },
        samples: []
      }
    }
  ]
}
```
